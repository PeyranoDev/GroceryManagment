FROM mcr.microsoft.com/dotnet/sdk:9.0 AS development

RUN apt-get update && \
    apt-get install -y \
    curl \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

RUN dotnet tool install --global dotnet-ef
ENV PATH="$PATH:/root/.dotnet/tools"

WORKDIR /app

ENV ASPNETCORE_ENVIRONMENT=Development
ENV ASPNETCORE_URLS=http://+:5000
ENV DOTNET_USE_POLLING_FILE_WATCHER=true
ENV DOTNET_WATCH_SUPPRESS_BROWSER_REFRESH=true
ENV POSTGRES_HOST=grocery-postgres-dev
ENV POSTGRES_PORT=5432
ENV POSTGRES_USER=grocery_user

EXPOSE 5000

COPY *.sln ./
COPY Domain/Domain.csproj ./Domain/
COPY Application/Application.csproj ./Application/
COPY Infraestructure/Infraestructure.csproj ./Infraestructure/
COPY Presentation/Presentation.csproj ./Presentation/

RUN dotnet restore

COPY . .

COPY entrypoint-dev.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint-dev.sh

ENTRYPOINT ["/usr/local/bin/entrypoint-dev.sh"]
CMD ["dotnet", "watch", "run", "--project", "Presentation", "--urls", "http://0.0.0.0:5000"]
